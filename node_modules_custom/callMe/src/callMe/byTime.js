"use strict";

var _ = require('lodash-node');
var when = require('when');

var cmn = require('../cmnData');
var createCall = require('../createCall');

var CALL_TYPE = 'callByTime';

function callByTime (evName, userUuid, callDateTime, data) {
    if (!_.isString(evName) || !_.isString(userUuid) || !_.isDate(callDateTime) || !_.isPlainObject(data)) {
        return when.reject('CallMeByTime: Ошибка типов параметров (evName:string, userUuid:string, callAtTime:date, data:plainObject');
    }
    return createCall(evName, userUuid, callDateTime, {evtype: CALL_TYPE}, data);
}

cmn.callMeTypes[CALL_TYPE] = function (evName, userUuid, evData, data) {
    var cb = cmn.eventCallbacks[evName];
    if (cb) {
        try {
            cb(data);
        } catch (e){
            console.error(e.stack);
            return when.reject();
        }
    } else {
        console.error('No callback for "'+evName+'"');
    }

    return when.resolve();
};

cmn.callMe.byTime = callByTime;