"use strict";

var when = require('when');
var whenPoll = require('when/poll');

var cmn = require('./cmnData');
var createClosestEventCall = require('./createClosestEventCall');

var SEC = 1000;

function createCall (evName, userUuid, callAtTime, callData, data) {
    var count = 0;

    return whenPoll(
        function() {
            return cmn.db.none('' +
                'INSERT INTO "call_by_time_events"' +
                ' ("event_type", "user_uuid", "call_at_time", "call_data", "event_data")' +
                ' VALUES (${event_type}, ${user_uuid}, ${call_at_time}, ${call_data}, ${event_data});',
                {
                    event_type: evName,
                    user_uuid: userUuid,
                    call_at_time: callAtTime,
                    call_data: JSON.stringify(data),
                    event_data: JSON.stringify(callData)
                }
            )
                .then(
                    null,
                    function(err) {
                        // Пытаемся 20 раз
                        if (++count <= 20) {
                            console.error(err);
                            return when.resolve('err');
                        }
                    }
                );
        },
        SEC,
        function(data) {
            return data !== 'err';
        }
    )
        .then(function(){
            createClosestEventCall();
        });
}

module.exports = createCall;