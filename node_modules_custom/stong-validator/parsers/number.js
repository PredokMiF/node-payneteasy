"use strict";

var _ = require('lodash-node');

var smartSpaceSplit = require('../spaceSplit');

function fromArr (fullKey, tpl, arrItems, cfg) {
    var items = smartSpaceSplit(tpl), item,
        i, l, t;

    var obj = {};

    if (items === false) {
        return 'Ошибка шаблона: В шаблоне присутствуют спец. знаки ' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
    }

    item = items[0];

    if (item === 'n' || item === 'num' || item === 'number') {
        obj.t = 'n';
    } else {
        return 'Ошибка шаблона: В шаблоне первым делом должен идти тип ' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
    }

    for (i = 1, l = items.length; i < l; i += 1) {
        item = items[i];
        switch (item) {
            case 'toNumber':
            case 'toNum':
                obj.toNum = true;
                obj.finite = true;
                break;
            case 'requiredKey':
            case 'reqKey':
                obj.reqKey = true;
                break;
            case 'null':
                obj.nullable = true;
                break;
            case 'default':
            case 'def':
                t = items[++i];
                if (!t) {
                    return 'Ошибка шаблона: Нет значения для "default"' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
                }
                t = t.replace(',', '.');
                obj.def = (t === 'null' ? null : +t);
                break;
            case 'finite':
                obj.finite = true;
                break;
            case 'min':
                obj.min = Number(items[++i]);
                if (!isFinite(obj.min)) {
                    return 'Ошибка шаблона: после min должно идти число ' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
                }
                break;
            case 'max':
                obj.max = Number(items[++i]);
                if (!isFinite(obj.max)) {
                    return 'Ошибка шаблона: после max должно идти число ' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
                }
                break;
            case 'isCeil':
                obj.isCeil = true;
                break;
            case 'ceil':
                obj.ceil = true;
                break;
            case 'round':
                obj.round = true;
                break;
            case 'floor':
                obj.floor = true;
                break;
            case 'toFixed':
                obj.toFixed = Number(items[++i]);
                if (!isFinite(obj.toFixed) || obj.toFixed < 0 || obj.toFixed % 1) {
                    return 'Ошибка шаблона: после toFixed должно идти целое неотрицательное число число ' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
                }
                break;
            default:
                return 'Ошибка шаблона: Неопознанный тег "' + item + '"' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
        }
    }

    if ( arrItems && _.some(arrItems, function (el, pos) { return !_.isFunction(el); })) {
        return 'Ошибка шаблона: Второй и все последующие элементы в переданном массиве должны быть функциями' + (fullKey ? (' (поле ' + fullKey + ')') : '') + ' ' + (new Error()).stack;
    }

    obj.customValidators = arrItems;

    return obj;
}

module.exports = {
    fromArr: fromArr
};