"use strict";

var _ = require('lodash-node');
var async = require('async');

var executorFn;

function executor (fullKey, tpl, cfg, obj, cb) {
    if (!executorFn) {
        executorFn = require('./executor');
    }

    if (!_.isArray(obj)) {
        cb('Ошибка валидации: Ожидался объект, а получили "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    async.reduce(
        _.map(obj, function (el, key) { return key; }),
        [],
        function (memo, key, cb) {
            executorFn(
                (fullKey ? fullKey + '.' + key : key),
                tpl.tpl,
                obj[key]
            ).then(
                function (result) {
                    memo[key] = result;
                    cb(null, memo);
                },
                function (err) {
                    cb(err);
                }
            );
        },
        function (err, result) {
            if (err) {
                cb(err);
            } else {
                tpl.customValidators = tpl.customValidators || [];

                if (_.every(
                    tpl.customValidators,
                    function (foo, pos) {
                        try {
                            if (!foo(obj, tpl, cfg)) {
                                cb('Ошибка валидации: Валидатор №' + pos + ' вернул ошибку' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                                return false;
                            }
                        } catch (e) {
                            cb('Ошибка валидации: Валидатор свалился с исключением' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                            return false;
                        }
                        return true;
                    }
                )) {
                    cb(null, result);
                }
            }
        }
    );
}

module.exports = executor;