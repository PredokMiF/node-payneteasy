"use strict";

var _ = require('lodash-node');

function executor (fullKey, tpl, cfg, obj, cb) {
    var t;

    if (tpl.nullable && (_.isNull(obj) || obj === undefined)) {
        cb(null, null);
        return;
    } else if (_.isNumber(obj)) {
        if (tpl.convNum) {
            obj = !!obj;
        } else {
            cb('Ошибка валидации: Ошибка конвертации числа в логическое выражение "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
            return;
        }
    } else if (_.isString(obj) && obj !== '') {
        if (tpl.convSNum && _.isFinite(t = +obj)) {
            obj = !!t;
        } else if ((tpl.convOnOff && ((t = obj === 'on') || obj === 'off')) || (tpl.convTrueFalse && ((t = obj === 'true') || obj === 'false'))) {
            obj = t;
        } else {
            cb('Ошибка валидации: Ошибка конвертации строки в логическое выражение "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
            return;
        }
    } else if (!_.isBoolean(obj)) {
        cb('Ошибка валидации: Ошибка конвертации в логическое выражение "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    tpl.customValidators = tpl.customValidators || [];

    _.every(
        tpl.customValidators,
        function (foo, pos) {
            try {
                if (!foo(obj, tpl, cfg)) {
                    cb('Ошибка валидации: Валидатор №' + pos + ' вернул ошибку' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                    return false;
                }
            } catch (e) {
                cb('Ошибка валидации: Валидатор свалился с исключением' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                return false;
            }
            return true;
        }
    );

    cb(null, obj);
}

module.exports = executor;