"use strict";

var _ = require('lodash-node');

function executor (fullKey, tpl, cfg, obj, cb) {
    var t;

    if (tpl.nullable && (_.isNull(obj) || obj === undefined)) {
        cb(null, null);
        return;
    } else if (tpl.toNum && !_.isNumber(obj)) {
        if (_.isString(obj) && obj !== '') {
            obj = obj.replace(',', '.');
            t = +obj;
            if (!_.isFinite(t)) {
                cb('Ошибка валидации: Ошибка конвертации строки в число "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                return;
            } else {
                obj = t;
            }
        } else if (obj === '' && tpl.nullable) {
            cb(null, null);
            return;
        } else {
            cb('Ошибка валидации: Ожидалась строка с числом или число, а пришло ' + (typeof obj) + ':' + JSON.stringify(obj) + (fullKey ? (' (поле ' + fullKey + ')') : ''));
            return;
        }
    }

    tpl.customValidators = tpl.customValidators || [];

    if (!_.isNumber(obj) || _.isNaN(obj)) {
        cb('Ошибка валидации: Ожидалось число, а пришло ' + (typeof obj) + ':' + JSON.stringify(obj) + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    if (tpl.finite && !_.isFinite(obj)) {
        cb('Ошибка валидации: Число должно быть конечным: ' + obj + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    if (tpl.min !== undefined && obj < tpl.min) {
        cb('Ошибка валидации: Минимальное значение ' + tpl.min + ', а у нас "'  + obj + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }
    if (tpl.max !== undefined && obj > tpl.max) {
        cb('Ошибка валидации: Максимальное значение ' + tpl.max + ', а у нас "'  + obj + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }
    if (tpl.isCeil && obj % 1 !== 0) {
        cb('Ошибка валидации: Число должно быть целым '  + obj + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }
    if (tpl.toFixed !== undefined) {
        obj = +obj.toFixed(tpl.toFixed);
    }
    if (tpl.round) {
        obj = Math.round(obj);
    }
    if (tpl.ceil) {
        obj = Math.ceil(obj);
    }
    if (tpl.floor) {
        obj = Math.floor(obj);
    }

    _.every(
        tpl.customValidators,
        function (foo, pos) {
            try {
                if (!foo(obj, tpl, cfg)) {
                    cb('Ошибка валидации: Валидатор №' + pos + ' вернул ошибку' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                    return false;
                }
            } catch (e) {
                cb('Ошибка валидации: Валидатор свалился с исключением' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                return false;
            }
            return true;
        }
    );

    cb(null, obj);
}

module.exports = executor;