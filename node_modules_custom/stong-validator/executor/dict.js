"use strict";

var _ = require('lodash-node');

function executor (fullKey, tpl, cfg, obj, cb) {
    var t;

    if (tpl.nullable && (_.isNull(obj) || obj === undefined)) {
        cb(null, null);
        return;
    } else if (_.isNumber(obj) && _.isFinite(obj)) {
        obj = '' + obj;
    }

    if (!_.isString(obj)) {
        cb('Ошибка валидации: Ожидалась строка, а пришло "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    if (tpl.val.indexOf(obj) === -1) {
        cb("Ошибка валидации: Пришло значение '" + obj + "', а возможны: ['" + tpl.val.join("', '") + "']" + (fullKey ? (' (поле ' + fullKey + ')') : ''));
    }

    tpl.customValidators = tpl.customValidators || [];

    _.every(
        tpl.customValidators,
        function (foo, pos) {
            try {
                if (!foo(obj, tpl, cfg)) {
                    cb('Ошибка валидации: Валидатор №' + pos + ' вернул ошибку' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                    return false;
                }
            } catch (e) {
                cb('Ошибка валидации: Валидатор свалился с исключением' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                return false;
            }
            return true;
        }
    );

    cb(null, obj);
}

module.exports = executor;