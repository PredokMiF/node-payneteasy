"use strict";

var _ = require('lodash-node');
var async = require('async');

var executorFn;

function executor (fullKey, tpl, cfg, obj, cb) {
    var objKeys, tKeys;

    if (!executorFn) {
        executorFn = require('./executor');
    }

    if (!_.isPlainObject(obj)) {
        cb('Ошибка валидации: Ожидался объект, а получили "' + obj + '"' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    // Проверяем ключи
    objKeys = _.map(obj, function (val, key) { return key; });
    if (!tpl.soft) {
        // Ищем лишние (необъявленные ключи)
        if ((tKeys = _.difference(objKeys, tpl.tplKeys)).length) {
            cb('Ошибка валидации: Пришли лишние ключи [' + tKeys.join(', ') + ']' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
            return;
        }
    }
    // Проверяем, все ли обязательные ключи объявлены
    if ((tKeys = _.difference(tpl.tplKeysReq, objKeys)).length) {
        cb('Ошибка валидации: Нет обязательных ключей [' + tKeys.join(', ') + ']' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    async.reduce(
        objKeys,
        {},
        function (memo, key, cb) {
            if (tpl.tplKeys.indexOf(key) === -1) {
                // Если ключа нет в шаблоне, но мы до сюда дошли - значение нужно просто перенести, т.к. выствлен режим soft
                memo[key] = obj[key];
                cb(null, memo);
            } else {
                executorFn(
                    (fullKey ? fullKey + '.' + key : key),
                    tpl.tpl[key],
                    obj[key]
                ).then(
                    function (result) {
                        memo[key] = result;
                        cb(null, memo);
                    },
                    function (err) {
                        cb(err);
                    }
                );
            }
        },
        function (err, result) {
            if (err) {
                cb(err);
            } else {
                tpl.customValidators = tpl.customValidators || [];

                if (_.every(
                    tpl.customValidators,
                    function (foo, pos) {
                        try {
                            if (!foo(obj, tpl, cfg)) {
                                cb('Ошибка валидации: Валидатор №' + pos + ' вернул ошибку' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                                return false;
                            }
                        } catch (e) {
                            cb('Ошибка валидации: Валидатор свалился с исключением' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                            return false;
                        }
                        return true;
                    }
                )) {
                    cb(null, result);
                }
            }
        }
    );
}

module.exports = executor;