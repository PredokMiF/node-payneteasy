"use strict";

var _ = require('lodash-node');

function executor (fullKey, tpl, cfg, obj, cb) {

    if (tpl.nullable && (_.isNull(obj) || obj === undefined)) {
        cb(null, null);
        return;
    } else if (tpl.toStr) {
        if (obj === null || obj === undefined) {
            obj = '';
        } else if (_.isFinite(obj)) {
            obj = '' + obj;
        }
    }

    tpl.customValidators = tpl.customValidators || [];

    if (!_.isString(obj)) {
        cb('Ошибка валидации: Ожидалась строка, а пришло ' + (typeof obj) + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }
    if (tpl.min !== undefined && obj.length < tpl.min) {
        cb('Ошибка валидации: Минимальная длинна строки ' + tpl.min + ', а у нас \''  + obj + '\':' + obj.length + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }
    if (tpl.max !== undefined && obj.length > tpl.max) {
        cb('Ошибка валидации: Максимальная длинна строки ' + tpl.max + ', а у нас \''  + obj + '\':' + obj.length + (fullKey ? (' (поле ' + fullKey + ')') : ''));
        return;
    }

    if (tpl.doTrim) {
        obj = obj.trim();
    }
    if (tpl.doToLower) {
        obj = obj.toLowerCase();
    }

    _.every(
        tpl.customValidators,
        function (foo, pos) {
            try {
                if (!foo(obj, tpl, cfg)) {
                    cb('Ошибка валидации: Валидатор №' + pos + ' вернул ошибку' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                    return false;
                }
            } catch (e) {
                cb('Ошибка валидации: Валидатор свалился с исключением' + (fullKey ? (' (поле ' + fullKey + ')') : ''));
                return false;
            }
            return true;
        }
    );

    cb(null, obj);
}

module.exports = executor;